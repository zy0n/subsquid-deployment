enum ActionType {
  CommitmentBatch
  GeneratedCommitmentBatch
  Shield
  Transact
  Nullifier
  Unshield
}

enum TokenType {
  ERC20
  ERC721
  ERC1155
}

type Token @entity {
  id: ID!
  tokenType: TokenType!
  tokenAddress: Bytes!
  tokenSubID: ID!
}

type CommitmentBatchCiphertext @entity {
  id: ID!
  batch: CommitmentBatch! # ✅ Parent ref
  ciphertext: [BigInt!]!
  ephemeralKeys: [BigInt!]!
  memo: [BigInt!]!
}

type GeneratedCommitmentBatchCommitment @entity {
  id: ID!
  batch: GeneratedCommitmentBatch! # ✅ Parent ref
  npk: BigInt!
  token: Token!
  value: BigInt!
}

type ShieldCommitment @entity {
  id: ID!
  shield: Shield! # ✅ Parent ref
  npk: BigInt!
  token: Token!
  value: BigInt!
}

type ShieldCiphertext @entity {
  id: ID!
  shield: Shield! # ✅ Parent ref
  encryptedBundle: [BigInt!]!
  shieldKey: BigInt!
}

type TransactCiphertext @entity {
  id: ID!
  transact: Transact! # ✅ Parent ref
  ciphertext: [BigInt!]!
  blindedSenderViewingKey: BigInt!
  blindedReceiverViewingKey: BigInt!
  annotationData: BigInt!
  memo: BigInt!
}

interface Action {
  id: ID!
  actionType: ActionType!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  blockHash: Bytes!
  transactions: [EVMTransaction!]!
}

type CommitmentBatch implements Action @entity {
  id: ID!
  actionType: ActionType!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  blockHash: Bytes!
  treeNumber: Int!
  startPosition: Int!
  hash: [BigInt!]!
  ciphertext: [CommitmentBatchCiphertext!]! @derivedFrom(field: "batch")
  transactions: [EVMTransaction!]! @derivedFrom(field: "actions")
}

type GeneratedCommitmentBatch implements Action @entity {
  id: ID!
  actionType: ActionType!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  blockHash: Bytes!
  treeNumber: Int!
  startPosition: Int!
  commitments: [GeneratedCommitmentBatchCommitment!]! @derivedFrom(field: "batch")
  encryptedRandom: [[BigInt!]!]!
  transactions: [EVMTransaction!]! @derivedFrom(field: "actions")
}

type Shield implements Action @entity {
  id: ID!
  actionType: ActionType!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  blockHash: Bytes!
  treeNumber: Int!
  startPosition: Int!
  commitments: [ShieldCommitment!]! @derivedFrom(field: "shield")
  shieldCiphertext: [ShieldCiphertext!]! @derivedFrom(field: "shield")
  transactions: [EVMTransaction!]! @derivedFrom(field: "actions")
}

type Transact implements Action @entity {
  id: ID!
  actionType: ActionType!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  blockHash: Bytes!
  treeNumber: Int!
  startPosition: Int!
  hash: [BigInt!]!
  ciphertext: [TransactCiphertext!]! @derivedFrom(field: "transact")
  railgunBatchIndex: Int!
  railgunTxidIndex: Int!
  transactions: [EVMTransaction!]! @derivedFrom(field: "actions")
}

type Nullifier implements Action @entity {
  id: ID!
  actionType: ActionType!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  blockHash: Bytes!
  treeNumber: BigInt!
  nullifier: [BigInt!]!
  transactions: [EVMTransaction!]! @derivedFrom(field: "actions")
}

type Unshield implements Action @entity {
  id: ID!
  actionType: ActionType!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  blockHash: Bytes!
  npk: BigInt!
  token: Token!
  amount: BigInt!
  fee: BigInt!
  transactions: [EVMTransaction!]! @derivedFrom(field: "actions")
}

type EVMTransaction @entity {
  id: ID!

  commitmentBatches: [CommitmentBatch!]! @derivedFrom(field: "transaction")
  generatedCommitmentBatches: [GeneratedCommitmentBatch!]! @derivedFrom(field: "transaction")
  shields: [Shield!]! @derivedFrom(field: "transaction")
  transacts: [Transact!]! @derivedFrom(field: "transaction")
  nullifiers: [Nullifier!]! @derivedFrom(field: "transaction")
  unshields: [Unshield!]! @derivedFrom(field: "transaction")
}